/**
 * MIT License
 *
 * Copyright (c) 2018 nasa.wang
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react"),require("react-dom"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","react","react-dom","lodash"],e):e(t.topology={},t.React,t.ReactDOM,t._)}(this,function(t,e,a,r){"use strict";r=r&&r.hasOwnProperty("default")?r.default:r;var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])};var o=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><rect class="body"/><rect class="card"/><rect class="alarm"/><text class="label"/><text class="type"/></g>',defaults:r.defaultsDeep({type:"VIM",size:{width:120,height:60},attrs:{".":{magnet:!1},".label":{text:"","ref-x":.5,"ref-y":.4,"font-size":14,"text-anchor":"middle",fill:"#000"},".type":{text:"","ref-x":.05,"ref-y":.7,"font-size":14,"text-anchor":"left",fill:"#000"},".alarm":{refX:"100%",refX2:-10,refY:"100%",refY2:-10,width:10,height:10},".body":{"ref-width":"100%","ref-height":"100%",stroke:"#00B388","stroke-width":3}}},joint.shapes.basic.Generic.prototype.defaults),initialize:function(){joint.shapes.basic.Generic.prototype.initialize.apply(this,arguments)}}),n=joint.dia.Link.extend({defaults:r.defaultsDeep({type:"Link",attrs:{".connection":{stroke:"#C6C9CA","stroke-width":3},".link-tools":{display:"none"},".marker-arrowheads":{display:"none"}},z:-1},joint.dia.Link.prototype.defaults),initialize:function(){joint.dia.Link.prototype.initialize.apply(this,arguments)}}),s=function(t){!function(t,e){i(t,e);function a(){this.constructor=t}t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}(a,t);function a(e){return t.call(this,e)||this}return a.prototype.doAnimate=function(){var t=this.graph,e=this.paper;t.on("signal",function(a,i){if(a instanceof joint.dia.Link){if(0==a.attributes.state){var o=t.getCell(a.get("target").id);e.findViewByModel(a).sendToken(V("circle",{r:7,fill:"green"}).node,1e3,function(){o.trigger("signal",o)})}}else{var n=t.getConnectedLinks(a,{outbound:!0});r.each(n,function(t){t.trigger("signal",t)})}});var a=[],i=[];r.map(t.getLinks(),function(t){a.push(t.get("source").id),i.push(t.get("target").id)});var o=r.sortedUniq(r.difference(a,i));setInterval(function(){r.map(o,function(e){var a=t.getCell(e);a.trigger("signal",a)})},3e3)},a.prototype.parseData=function(t){var e=this;t.nodes&&(r.map(t.nodes,function(t){var a={isHighlight:t.id===e.props.cid};new o(function(t){var e={size:{},attrs:{".label":{},".type":{},".alarm":{},".body":{}}},a="";if(t)switch(t.id&&(e.id=t.id),t.isHighlight&&(e.attrs[".body"].stroke="#2AD2C9"),t.bizFields&&(e.bizFields=t.bizFields),t.label&&(a='data-tooltip="'+t.label+'"',e.markup='<g class="rotatable" '+a+'><rect class="body"/><rect class="card"/><rect class="alarm"/><text class="label"/><text class="type"/></g>'),t.type&&(e.attrs[".label"].text=t.type),t.state){case 0:e.attrs[".alarm"].width=0,e.attrs[".alarm"].height=0;break;case 1:e.attrs[".alarm"].fill="#D10002";break;case 2:e.attrs[".alarm"].fill="#FF9901";break;case 3:e.attrs[".alarm"].fill="#DFB202";break;case 4:e.attrs[".alarm"].fill="#00BFFF";break;default:e.attrs[".alarm"].width=0,e.attrs[".alarm"].height=0}return e}(r.merge(t,a))).addTo(e.graph)}),t.links&&r.map(t.links,function(t){new n(function(t){var e={attrs:{".connection":{stroke:"#C6C9CA","stroke-dasharray":""}}};if(t)switch(e.state=t.state,e.source={id:t.source},e.target={id:t.target},t.state){case 0:e.attrs[".connection"].stroke="#C6C9CA";break;case 1:e.attrs[".connection"].stroke="#D10002",e.attrs[".connection"]["stroke-dasharray"]="5 2";break;case 2:e.attrs[".connection"].stroke="#FF9901",e.attrs[".connection"]["stroke-dasharray"]="5 2";break;case 3:e.attrs[".connection"].stroke="#DFB202",e.attrs[".connection"]["stroke-dasharray"]="5 2";break;case 4:e.attrs[".connection"].stroke="#00BFFF",e.attrs[".connection"]["stroke-dasharray"]="5 2";break;default:e.attrs[".connection"].stroke="#31d0c6",e.attrs[".connection"]["stroke-dasharray"]="5 2"}return e}(t)).addTo(e.graph)}))},a.prototype.initializePaper=function(){var t=this,e=this.graph=new joint.dia.Graph;this.commandManager=new joint.dia.CommandManager({graph:e});var a=this.paper=new joint.dia.Paper({width:this.props.paper_width,height:this.props.paper_height,gridSize:10,drawGrid:this.props.drawGrid,model:e,perpendicularLinks:!0,restrictTranslate:!0});this.parseData(this.props.data),this.props.animate&&this.doAnimate();var i=this.paperScroller=new joint.ui.PaperScroller({paper:a,autoResizePaper:!0,cursor:"grab"});a.on("blank:pointerdown",i.startPanning),$(this.paperContainer).append(i.el);joint.layout.DirectedGraph.layout(e,{nodeSep:50,edgeSep:80,marginX:100,marginY:20,rankSep:100,rankDir:this.props.rankDir});i.render(),this.props.center&&i.center(),this.props.zoomToFit&&i.zoomToFit(),new joint.ui.Tooltip({target:"[data-tooltip]",content:function(t){var e=r.split(t.attributes["data-tooltip"].nodeValue,"|");return r.map(r.split(t.attributes["data-tooltip"].nodeValue,"|"),function(t,a){return 0==a&&e.length>1?e[0]!=e[1]?"<b>"+t+"</b><hr />":"":t})}}),a.on("cell:pointerdblclick",function(e){t.props.onDblclick&&t.props.onDblclick(e)}),this.btn_zoomin.onclick=this.zoomIn.bind(this),this.btn_zoomout.onclick=this.zoomOut.bind(this)},a.prototype.zoomIn=function(){this.paperScroller.zoom(.2,{max:2})},a.prototype.zoomOut=function(){this.paperScroller.zoom(-.2,{min:.2})},a.prototype.componentDidMount=function(){this.initializePaper()},a.prototype.render=function(){var t=this;return e.createElement("div",{className:"Topology",style:{width:this.props.width,height:this.props.height}},e.createElement("div",{className:"topology-app"},e.createElement("div",{className:"app-body"},e.createElement("div",{ref:function(e){t.btn_zoomin=e},id:"btn-zoomin",className:"btn"},"+"),e.createElement("div",{ref:function(e){t.btn_zoomout=e},id:"btn-zoomout",className:"btn"},"-"),e.createElement("div",{className:"paper-container",ref:function(e){t.paperContainer=e}}))))},a.defaultProps={animate:!0,width:800,height:600,paper_width:1e3,paper_height:1e3,drawGrid:!1,rankDir:"TB",data:{},center:!1,zoomToFit:!1},a}(e.Component);t.init=function(t,r){void 0===t&&(t="root"),a.render(e.createElement(s,{animate:r.animate,cid:r.cid,data:r.data,onDblclick:r.onDblclick,width:r.width,height:r.height}),document.getElementById(t))},t.Topology=s,Object.defineProperty(t,"__esModule",{value:!0})});

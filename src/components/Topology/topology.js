/**
 * Copyright nasa.wang 2018
 * version: 1.0.0
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react"),require("react-dom"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","react","react-dom","lodash"],e):e(t.topology={},t.React,t.ReactDOM,t._)}(this,function(t,e,a,i){"use strict";i=i&&i.hasOwnProperty("default")?i.default:i;var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])};var o=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><rect class="body"/><rect class="card"/><rect class="alarm"/><text class="label"/></g>',defaults:i.defaultsDeep({type:"VIM",size:{width:180,height:60},attrs:{".":{magnet:!1},".label":{text:"","ref-x":.5,"ref-y":.4,"font-size":14,"text-anchor":"middle",fill:"#000"},".alarm":{refX:"100%",refX2:-10,refY:"100%",refY2:-10,width:10,height:10},".body":{"ref-width":"100%","ref-height":"100%",stroke:"#00b388","stroke-width":3}}},joint.shapes.basic.Generic.prototype.defaults),initialize:function(){joint.shapes.basic.Generic.prototype.initialize.apply(this,arguments)}}),n=joint.dia.Link.extend({defaults:i.defaultsDeep({type:"Link",attrs:{".connection":{stroke:"#31d0c6","stroke-width":3},".link-tools":{display:"none"},".marker-arrowheads":{display:"none"}},z:-1},joint.dia.Link.prototype.defaults),initialize:function(){joint.dia.Link.prototype.initialize.apply(this,arguments)}}),s=function(t){!function(t,e){r(t,e);function a(){this.constructor=t}t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}(a,t);function a(e){return t.call(this,e)||this}return a.prototype.doAnimate=function(){var t=this.graph,e=this.paper;t.on("signal",function(a,r){if(a instanceof joint.dia.Link){if(0==a.attributes.state){var o=t.getCell(a.get("target").id);e.findViewByModel(a).sendToken(V("circle",{r:7,fill:"green"}).node,1e3,function(){o.trigger("signal",o)})}}else{var n=t.getConnectedLinks(a,{outbound:!0});i.each(n,function(t){t.trigger("signal",t)})}});var a=[],r=[];i.map(t.getLinks(),function(t){a.push(t.get("source").id),r.push(t.get("target").id)});var o=i.sortedUniq(i.difference(a,r));setInterval(function(){i.map(o,function(e){var a=t.getCell(e);a.trigger("signal",a)})},3e3)},a.prototype.parseData=function(t){var e=this;t.nodes&&(i.map(t.nodes,function(t){new o(function(t){var e={size:{},attrs:{".label":{},".alarm":{}}},a="";if(t){switch(t.id&&(e.id=t.id),t.bizFields&&(e.bizFields=t.bizFields),t.desc&&(a='data-tooltip="'+t.desc+'"',e.markup='<g class="rotatable" '+a+'><rect class="body"/><rect class="card"/><rect class="alarm"/><text class="label"/></g>'),t.label&&(e.attrs[".label"].text=t.label),t.state){case 0:e.attrs[".alarm"].width=0,e.attrs[".alarm"].height=0;break;case 1:e.attrs[".alarm"].fill="#D10002";break;case 2:e.attrs[".alarm"].fill="#FF9901";break;case 3:e.attrs[".alarm"].fill="#DFB202";break;case 4:e.attrs[".alarm"].fill="#00BFFF";break;default:e.attrs[".alarm"].width=0,e.attrs[".alarm"].height=0}switch(t.type){case"pnc":e.size={width:140,height:60};break;case"pno":e.size={width:80,height:40};break;case"ovs":e.size={width:320,height:60};break;case"vnc":e.size={width:20,height:20};break;case"vm":case"HA":e.size={width:140,height:60}}}return e}(t)).addTo(e.graph)}),t.links&&i.map(t.links,function(t){new n(function(t){var e={attrs:{".connection":{stroke:"#31d0c6","stroke-dasharray":""}}};if(t)switch(e.state=t.state,e.source={id:t.source},e.target={id:t.target},t.state){case 0:e.attrs[".connection"].stroke="#31d0c6";break;case 1:e.attrs[".connection"].stroke="#D10002",e.attrs[".connection"]["stroke-dasharray"]="5 2";break;case 2:e.attrs[".connection"].stroke="#FF9901",e.attrs[".connection"]["stroke-dasharray"]="5 2";break;case 3:e.attrs[".connection"].stroke="#DFB202",e.attrs[".connection"]["stroke-dasharray"]="5 2";break;case 4:e.attrs[".connection"].stroke="#00BFFF",e.attrs[".connection"]["stroke-dasharray"]="5 2";break;default:e.attrs[".connection"].stroke="#31d0c6",e.attrs[".connection"]["stroke-dasharray"]="5 2"}return e}(t)).addTo(e.graph)}))},a.prototype.initializePaper=function(){var t=this,e=this.graph=new joint.dia.Graph;this.commandManager=new joint.dia.CommandManager({graph:e});var a=this.paper=new joint.dia.Paper({width:this.props.paper_widht,height:this.props.paper_height,gridSize:10,drawGrid:this.props.drawGrid,model:e,perpendicularLinks:!0,restrictTranslate:!0});this.parseData(this.props.data),this.props.animate&&this.doAnimate();var i=this.paperScroller=new joint.ui.PaperScroller({paper:a,autoResizePaper:!0,cursor:"grab"});a.on("blank:pointerdown",i.startPanning),$(this.paperContainer).append(i.el);joint.layout.DirectedGraph.layout(e,{nodeSep:50,edgeSep:80,marginX:100,marginY:20,rankSep:100,rankDir:this.props.rankDir});i.render(),this.props.center&&i.center(),this.props.zoomToFit&&i.zoomToFit(),new joint.ui.Tooltip({target:"[data-tooltip]"}),a.on("cell:pointerdblclick",function(e){t.props.onDblclick&&t.props.onDblclick(e)}),this.btn_zoomin.onclick=this.zoomIn.bind(this),this.btn_zoomout.onclick=this.zoomOut.bind(this)},a.prototype.zoomIn=function(){this.paperScroller.zoom(.2,{max:2})},a.prototype.zoomOut=function(){this.paperScroller.zoom(-.2,{min:.2})},a.prototype.componentDidMount=function(){this.initializePaper()},a.prototype.render=function(){var t=this;return e.createElement("div",{className:"Topology",style:{width:this.props.width,height:this.props.height}},e.createElement("div",{className:"topology-app"},e.createElement("div",{className:"app-body"},e.createElement("div",{ref:function(e){t.btn_zoomin=e},id:"btn-zoomin",className:"btn"},"+"),e.createElement("div",{ref:function(e){t.btn_zoomout=e},id:"btn-zoomout",className:"btn"},"-"),e.createElement("div",{className:"paper-container",ref:function(e){t.paperContainer=e}}))))},a.defaultProps={animate:!0,width:800,height:600,paper_widht:1e3,paper_height:1e3,drawGrid:!1,rankDir:"TB",data:{},center:!1,zoomToFit:!1},a}(e.Component);t.init=function(t,i){void 0===t&&(t="root"),a.render(e.createElement(s,{animate:i.animate,data:i.data,onDblclick:i.onDblclick}),document.getElementById(t))},t.Topology=s,Object.defineProperty(t,"__esModule",{value:!0})});
